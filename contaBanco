CREATE DATABASE DB_REIS
USE DB_REIS

CREATE DATABASE DB_REIS
USE DB_REIS

DROP TABLE vendas

CREATE TABLE produto(
	codigo int primary key,
	nome varchar(80),
	vlrUnit numeric(7,3),
	qtde int,
	inss int,
	ipi int,
	pis int,
	cof int,
	csl int,
	icms int
)

CREATE TABLE vendas(
	codigoVend int primary key identity,
	codProd int,
	nome varchar(80),
	vlrTotal numeric(7,3)
)

INSERT INTO produto VALUES (150, 'MONITOR', 780.00, 2, 8, 5, 6, 4, 3, 10)
INSERT INTO produto VALUES (147, 'CPU', 1250.00, 3, 9, 6, 5, 2, 4, 7)
INSERT INTO produto VALUES (168, 'HD SSD', 640.00, 4, 5, 8, 9, 7, 6, 17)

CREATE TRIGGER Tr_calculaValorTotal
FOR INSERT vlrTotal
AS
DECLARE @codProd int, @nome varchar(80), @vlrUnit numeric(7,3), @qtde int, @impostos int
select @codProd = codigo from inserted 
select @nome = nome from inserted
select @vlrUnit = vlrUnit from inserted
select @qtde = qtde from inserted
select @impostos = inss + ipi + pis + cof + csl + icms from produto









CREATE TABLE CONTA(
CODIGO INT PRIMARY KEY IDENTITY,
DATA DATETIME,
SALDO_FINAL NUMERIC(10,2),
BANCO INT,
AGENCIA VARCHAR(6),
CONTA VARCHAR(10)
)

CREATE TABLE PAGTO
(CODIGO INT PRIMARY KEY IDENTITY,
DATA DATETIME,
TIPO CHAR(1),
VALOR NUMERIC(10,2),
BANCO INT,
AGENCIA VARCHAR(6),
CONTA VARCHAR(10)
)

CREATE TRIGGER Tr_verifica ON PAGTO
FOR INSERT
AS
DECLARE @tipo char, @banco int, @agencia varchar(6), @conta varchar(10), @valor NUMERIC(10,2)
select @tipo = TIPO from inserted 
select @banco = BANCO from inserted 
select @agencia = AGENCIA from inserted 
select @conta = CONTA from inserted 
select @valor = VALOR from inserted 

DECLARE @valor_final NUMERIC(10,2)
SET @valor_final = (SELECT SALDO_FINAL FROM CONTA WHERE CONTA = @conta AND
AGENCIA = @agencia AND BANCO = @BANCO)

if @tipo = 'D' AND @valor > @valor_final
	BEGIN
		PRINT('ERRO: O valor Ã© maior que o saldo.')
		ROLLBACK TRANSACTION
	END
else if @tipo = 'D'
	BEGIN
		update CONTA set SALDO_FINAL = @valor - @valor_final WHERE CONTA = @conta AND
		AGENCIA = @agencia AND BANCO = @BANCO
	END
else
	BEGIN
		update CONTA set SALDO_FINAL = @valor - @valor_final WHERE CONTA = @conta AND
		AGENCIA = @agencia AND BANCO = @BANCO
	END
